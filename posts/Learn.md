# 学习笔记

## 博客系统开发

### Markdown 增强功能实现 (2024-01-15)

- 成功添加多个 Markdown 插件：Admonitions、脚注、高亮、数学公式等
- 学会使用 remark 和 rehype 生态系统增强 Markdown 渲染
- 脚注样式优化：使用 CSS 优先级确保无下划线显示 `text-decoration: none !important`
- 样式系统：针对.prose 类进行 CSS 定制，支持暗色模式

### Mermaid 图表集成 (2025-01-22)

- **技术栈**：`remark-mermaid` + `rehype-mermaid`
- **功能特性**：
  - 支持流程图、时序图、甘特图等多种图表类型
  - 内联 SVG 渲染，支持暗色模式
  - 代码块语言高亮支持 `mermaid`
- **配置细节**：
  - 使用 `strategy: "inline-svg"` 渲染图表
  - 启用 `dark: true` 支持暗色主题
- **测试文档**：`markdown-features-test.md` 添加了多个图表示例
- **性能优化**：使用轻量级的 Mermaid 渲染策略

### 搜索功能实现 (2025-01-20)

- **技术栈**: Fuse.js + React + Next.js API Routes + react-hotkeys-hook
- **核心组件结构**:
  - `SearchModal`: 主搜索界面，包含输入框、结果显示、键盘导航
  - `SearchButton`: 搜索触发按钮，显示快捷键提示
  - `Search`: 状态管理包装组件
  - `/api/search/route.ts`: 服务端搜索 API
- **关键技术点**:
  - Fuse.js 配置：设置搜索权重、阈值、匹配长度等参数
  - 防抖搜索：使用 useEffect + setTimeout 实现 300ms 防抖
  - 键盘导航：useHotkeys 钩子处理快捷键和方向键
  - 文本高亮：解析 Fuse.js 匹配结果，动态生成 HTML 高亮
  - 状态管理：搜索状态、选中索引、加载状态的协调管理
- **用户体验优化**:
  - 自动聚焦输入框
  - 选中项自动滚动到可视区域
  - 搜索结果实时更新
  - 错误状态友好提示
  - 快捷键提示界面
- **集成方式**: 在 Header 组件中添加 Search 组件，与主题切换器并列显示
- **性能考虑**:
  - 搜索结果限制为 10 个
  - 最小搜索长度 2 个字符
  - 合理的搜索阈值避免过多无关结果

### Bug 修复经验 (2025-01-20)

- **搜索功能键盘导航问题**:
  - 问题：Esc 键无效，选中项高亮不明显
  - 解决：为 useHotkeys 添加`enableOnFormTags: true`确保在输入框中也能响应
  - 高亮改进：使用 border-l-2 和 bg-primary/10 提供更明显的选中效果
  - 添加 scrollIntoView 实现选中项自动滚动到可视区域
- **TOC 响应式布局问题**:
  - 问题：在移动端 TOC 仍然显示，占用空间
  - 解决：将`lg:block`改为`hidden lg:block`，确保小屏幕上隐藏
  - 布局调整：使用 flex-col lg:flex-row-reverse 实现响应式布局
- **目录宽度导致内容挤压问题**:
  - 问题：右侧目录过宽（w-80），挤压主内容区域
  - 解决：
    1. 目录宽度从`w-80`减小到`w-64`
    2. 使用`lg:max-w-[calc(100%-16rem)]`动态计算主内容区域宽度
    3. 减少左侧内边距从`lg:pl-8`到`lg:pl-4`
  - 优化：保持布局灵活性，确保内容不被过宽的目录压缩

### 细节优化 (2025-01-21)

- **目录位置微调**:
  - 问题：目录位置不够理想
  - 解决：将`lg:ml-10`调整为`lg:ml-12`，稍微右移目录
  - 目的：提供更好的视觉平衡和阅读体验

### Fixed 定位问题修复 (2025-01-22)

- **问题描述**: ReadingProgress 组件的 `position: fixed` 定位失效，进度条无法正常显示
- **问题分析**:
  - 初步怀疑是组件本身的 z-index 或 duration 类名问题
  - 实际发现是全局 CSS 样式影响了 fixed 定位的层叠上下文
- **根本原因**: `src/styles/animations.css` 中的全局样式规则：
  ```css
  *,
  *::before,
  *::after {
    transform: translateZ(0); /* 这行代码创建了新的层叠上下文 */
  }
  ```
- **技术原理**:
  - 全局的 `transform` 属性为每个元素创建新的**层叠上下文（stacking context）**
  - 导致 `position: fixed` 元素不再相对于视口定位，而是相对于最近的具有 transform 属性的父元素
- **解决方案**:
  1. **移除重复组件**: 发现 ReadingProgress 在 layout 和 page 中都被引用，移除重复
  2. **修复全局样式**: 将全局硬件加速样式改为可选的 `.hardware-accelerated` 类
  3. **提高 z-index**: 从 `z-50` 改为 `z-[100]` 确保显示在最顶层
  4. **修复 duration 类**: 从不存在的 `duration-fast` 改为标准的 `duration-300`
- **修复后效果**:
  - 进度条正常显示为屏幕左侧的细线
  - 固定定位工作正常，不随页面滚动
  - 根据阅读进度显示彩色渐变
  - 平滑的动画过渡效果
- **经验教训**:
  - 全局 CSS 样式要谨慎使用，特别是 transform 属性
  - fixed 定位问题往往不是组件本身的问题，而是父容器的层叠上下文影响
  - 硬件加速优化应该精确应用到需要的元素，而不是全局应用
  - 调试 CSS 定位问题时要从根本的层叠上下文和包含块概念入手

### 开发经验总结

- **模块化设计**：将复杂功能拆分为独立组件，便于维护和复用
- **渐进增强**：先实现基础功能，再添加交互优化
- **用户体验优先**：快捷键、键盘导航、视觉反馈等细节决定产品质量
- **错误处理**：充分考虑网络错误、空结果、输入验证等边界情况
- **性能优化**：防抖、限制结果数量、合理的搜索参数等提升响应速度

### 技术债务和优化方向

- [ ] 考虑添加搜索历史记录
- [ ] 实现搜索结果的分类显示（按标签、日期等）
- [ ] 添加搜索统计和热门搜索词
- [ ] 考虑使用 Web Workers 进行客户端搜索优化
- [ ] 搜索结果的 SEO 友好 URL 支持
